from dataclasses import dataclass, field
from typing import List


@dataclass
class Config:    
    sd_model: str = "AI-ModelScope/stable-diffusion-2-1"  # ModelScope mirror
    sd_model_hf: str = "stabilityai/stable-diffusion-2-1"  # HF (requires token/access)
    captioner_model: str = "Salesforce/blip2-flan-t5-xl"
    embedder_model: str = "kasraarabi/finetuned-caption-embedding"
    fallback_embedder: str = "sentence-transformers/paraphrase-mpnet-base-v2"
    
    use_modelscope: bool = True 
        n_patches: int = 1024    
    bits_per_patch: int = 7   
    patch_size: int = 2      
    tau: float = 2.3        
    
    gen_steps: int = 50      
    inv_steps: int = 50       
    guidance_scale: float = 7.5
    
    secret_salt: str = "seal_watermark_salt_2024"
    
    n_search_captions: int = 16  
    
    n_wm: int = 500            
    n_neg: int = 1000        
    prompt_dataset: str = "Gustavosta/Stable-Diffusion-Prompts"
    
    shuffle_seed: int = 42     
    global_seed: int = 0       
    
    transforms: List[str] = field(default_factory=lambda: [
        "Original",
        "Rotation_75",
        "JPEG_25",
        "Crop_Scale_0.75",
        "Gaussian_Blur_8x8",
        "Gaussian_Noise_0.1",
        "Brightness_U06"
    ])
    
    detection_threshold: int = 12  
    
    def __post_init__(self):
        """Validate configuration"""
        assert self.n_patches > 0, "n_patches must be positive"
        assert self.bits_per_patch > 0, "bits_per_patch must be positive"
        assert self.patch_size > 0, "patch_size must be positive"
        assert self.tau > 0, "tau must be positive"
        assert 0 < self.guidance_scale <= 20, "guidance_scale must be in (0, 20]"
        assert self.n_wm > 0, "n_wm must be positive"
        assert self.n_neg > 0, "n_neg must be positive"
        assert self.n_search_captions > 0, "n_search_captions must be positive"


def load_config(config_path: str = None) -> Config:
    """Load configuration from YAML file or use defaults"""
    if config_path is None:
        return Config()
    
    import yaml
    from pathlib import Path
    
    path = Path(config_path)
    if not path.exists():
        print(f"Warning: Config file {config_path} not found. Using defaults.")
        return Config()
    
    with open(path) as f:
        config_dict = yaml.safe_load(f)
    
    return Config(**config_dict)
